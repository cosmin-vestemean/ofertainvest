IF NOT EXISTS (
	SELECT 1
	FROM sys.tables
	WHERE name = 'CCCOFERTEWEB'
) BEGIN CREATE TABLE CCCOFERTEWEB (
	CCCOFERTEWEB INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	NAME VARCHAR(100) NOT NULL,
	FILENAME VARCHAR(MAX) NOT NULL,
	TRNDATE DATETIME NOT NULL DEFAULT GETDATE(),
	TRDR INT NOT NULL,
	PRJC INT NOT NULL,
	JSONSTR VARCHAR(MAX) NOT NULL,
	JSONANTESTR VARCHAR(MAX),
	JSONINSTRETSTR VARCHAR(MAX),
	JSONRETETESTR VARCHAR(MAX),
	JSONTREESSTR VARCHAR(MAX),
	JSONESTIMPOOLSTR VARCHAR(MAX),
	JSONTREESTR VARCHAR(MAX)
)
END;
/*
 WBS, GRUPARE_ARTICOL_OFERTA, DENUMIRE_ARTICOL_OFERTA, SERIE_ARTICOL_OFERTA, TIP_ARTICOL_OFERTA, SUBTIP_ARTICOL_OFERTA, NIVEL_OFERTA_1, NIVEL_OFERTA_2, UM_ARTICOL_OFERTA, CANTITATE_ARTICOL_OFERTA, COST_UNITAR_MATERIAL_ARTICOL_OFERTA, COST_UNITAR_MANOPERA_ARTICOL_OFERTA, COST_UNITAR_UTILAJ_ARTICOL_OFERTA, COST_UNITAR_TRANSPORT_ARTICOL_OFERTA, NORMA_UNITARA_ORE_MANOPERA_ARTICOL_OFERTA, COST_UNITAR_ARTICOL_OFERTA, COST_TOTAL_MATERIAL_ARTICOL_OFERTA, COST_TOTAL_MANOPERA_ARTICOL_OFERTA, COST_TOTAL_UTILAJ_ARTICOL_OFERTA, COST_TOTAL_TRANSPORT_ARTICOL_OFERTA, COST_TOTAL_ARTICOL_OFERTA, TOTAL_ORE_MANOPERA_ARTICOL_OFERTA, PRET_UNITAR_MATERIAL_ARTICOL_OFERTA, PRET_UNITAR_MANOPERA_ARTICOL_OFERTA, PRET_UNITAR_UTILAJ_ARTICOL_OFERTA, PRET_UNITAR_TRANSPORT_ARTICOL_OFERTA, PRET_UNITAR_ARTICOL_ARTICOL_OFERTA, PRET_TOTAL_MATERIAL_ARTICOL_OFERTA, PRET_TOTAL_MANOPERA_ARTICOL_OFERTA, PRET_TOTAL_UTILAJ_ARTICOL_OFERTA, PRET_TOTAL_TRANSPORT_ARTICOL_OFERTA, PRET_TOTAL_ARTICOL_ARTICOL_OFERTA
 column names will be truncated to max 30 characters like the following:
 */
IF NOT EXISTS (
	SELECT 1
	FROM sys.tables
	WHERE name = 'CCCOFERTEWEBLINII'
) BEGIN CREATE TABLE CCCOFERTEWEBLINII (
	CCCOFERTEWEBLINII INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCOFERTEWEB INT NOT NULL,
	WBS VARCHAR(100) NOT NULL,
	GRUPARE_ART_OF VARCHAR(100),
	DENUMIRE_ART_OF VARCHAR(350) NOT NULL,
	SERIE_ART_OF VARCHAR(100),
	TIP_ART_OF VARCHAR(100) NOT NULL,
	SUBTIP_ART_OF VARCHAR(100) NOT NULL,
	NIVEL_OF_1 VARCHAR(100),
	NIVEL_OF_2 VARCHAR(100),
	NIVEL_OF_3 VARCHAR(100),
	NIVEL_OF_4 VARCHAR(100),
	NIVEL_OF_5 VARCHAR(100),
	NIVEL_OF_6 VARCHAR(100),
	NIVEL_OF_7 VARCHAR(100),
	NIVEL_OF_8 VARCHAR(100),
	NIVEL_OF_9 VARCHAR(100),
	NIVEL_OF_10 VARCHAR(100),
	UM_ART_OF VARCHAR(10) NOT NULL,
	CANT_ART_OF FLOAT NOT NULL,
	COST_UNTR_MTRL_ART_OF FLOAT,
	COST_UNTR_MAN_ART_OF FLOAT,
	COST_UNTR_UTL_ART_OF FLOAT,
	COST_UNTR_TRNS_ART_OF FLOAT,
	NORMA_UNTR_ORE_MAN_ART_OF FLOAT,
	COST_UNTR_ART_OF FLOAT,
	COST_TOTAL_MTRL_ART_OF FLOAT,
	COST_TOTAL_MAN_ART_OF FLOAT,
	COST_TOTAL_UTL_ART_OF FLOAT,
	COST_TOTAL_TRNS_ART_OF FLOAT,
	COST_TOTAL_ART_OF FLOAT,
	TOTAL_ORE_MAN_ART_OF FLOAT,
	PRET_UNTR_MTRL_ART_OF FLOAT,
	PRET_UNTR_MAN_ART_OF FLOAT,
	PRET_UNTR_UTL_ART_OF FLOAT,
	PRET_UNTR_TRNS_ART_OF FLOAT,
	PRET_UNTR_ART_ART_OF FLOAT,
	PRET_TOTAL_MTRL_ART_OF FLOAT,
	PRET_TOTAL_MAN_ART_OF FLOAT,
	PRET_TOTAL_UTL_ART_OF FLOAT,
	PRET_TOTAL_TRNS_ART_OF FLOAT,
	PRET_TOTAL_ART_ART_OF FLOAT,
	INITIAL_PATH VARCHAR(MAX),
	ISCUSTOM SMALLINT NOT NULL DEFAULT 0
)
END;
IF NOT EXISTS (
	SELECT 1
	FROM sys.tables
	WHERE name = 'CCCWEBERRORS'
) BEGIN CREATE TABLE CCCWEBERRORS (
	CCCWEBERRORS INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	TRNDATE DATETIME NOT NULL DEFAULT GETDATE(),
	ERRORNUMBER INT NOT NULL,
	ERRORSEVERITY INT NOT NULL,
	ERRORSTATE INT NOT NULL,
	ERRORPROCEDURE VARCHAR(100),
	ERRORLINE INT NOT NULL,
	ERRORMESSAGE VARCHAR(MAX) NOT NULL
)
END;
--select version
SELECT @@VERSION;
/*Microsoft SQL Server 2012 - 11.0.5058.0 (X64) 
 May 14 2014 18:34:29 
 Copyright (c) Microsoft Corporation
 Standard Edition (64-bit) on Windows NT 6.3 <X64> (Build 20348: ) (Hypervisor)
 */
create TABLE CCCUNIQNODES (
	CCCOFERTEWEB INT NOT NULL,
	CCCUNIQNODES INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	NAME VARCHAR(100) NOT NULL
);
CREATE TABLE CCCPATHS (
	CCCPATHS INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCOFERTEWEB INT NOT NULL,
	PATH VARCHAR(MAX) NOT NULL,
	ISEXTENSIBLE SMALLINT NOT NULL DEFAULT 1
);
create table CCCRETETE (
	CCCOFERTEWEB INT NOT NULL,
	CCCRETETE INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	NAME VARCHAR(100) NOT NULL,
	TYPE VARCHAR(25) NOT NULL,
	ID INT NOT NULL,
);
CREATE TABLE CCCACTIVITRETETE (
	CCCOFERTEWEB INT NOT NULL,
	CCCRETETE INT NOT NULL,
	CCCACTIVITRETETE INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCOFERTEWEBLINII INT NOT NULL,
	SUMCANTANTE FLOAT NOT NULL,
	AVGNORMUNITOREMAN FLOAT NOT NULL,
	SUMOREMAN FLOAT,
	ISMAIN SMALLINT NOT NULL DEFAULT 0,
	ISCUSTOM SMALLINT NOT NULL DEFAULT 0,
	ALTNAME VARCHAR(MAX)
);
--rename code for CANTITATEUNITARA (SUMCANTANTE), PONDEREDECONT (AVGNORMUNITOREMAN), PONDERENORMA (SUMOREMAN)
exec sp_rename 'CCCACTIVITRETETE.CANTITATEUNITARA',
'SUMCANTANTE',
'COLUMN';
exec sp_rename 'CCCACTIVITRETETE.PONDEREDECONT',
'AVGNORMUNITOREMAN',
'COLUMN';
exec sp_rename 'CCCACTIVITRETETE.PONDERENORMA',
'SUMOREMAN',
'COLUMN';
CREATE TABLE CCCMATRETETE (
	CCCOFERTEWEB INT NOT NULL,
	CCCRETETE INT NOT NULL,
	CCCMATRETETE INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCACTIVITRETETE INT NOT NULL,
	CCCOFERTEWEBLINII INT NOT NULL,
	CANTTOTAL FLOAT NOT NULL,
	CANTUNIT FLOAT NOT NULL,
	CANTREAL FLOAT,
	CANTREALUNIT FLOAT,
	NORMUNITMAN FLOAT,
	TOTALOREMAN FLOAT,
	PONNORMMAN FLOAT,
	ISCUSTOM SMALLINT NOT NULL DEFAULT 0,
	ALTNAME VARCHAR(MAX),
	ISARTOF SMALLINT NOT NULL DEFAULT 0
);
--rename CANTITATEUNITARA > CANTTOTAL, PONDEREDECONT > CANTUNIT, PONDERENORMA > CANTREAL and add new columns: CANTREALUNIT, NORMUNITMAN, TOTALOREMAN, PONNORMMAN
exec sp_rename 'CCCMATRETETE.CANTITATEUNITARA', 'CANTTOTAL', 'COLUMN';
exec sp_rename 'CCCMATRETETE.PONDEREDECONT', 'CANTUNIT', 'COLUMN';
exec sp_rename 'CCCMATRETETE.PONDERENORMA', 'CANTREAL', 'COLUMN';
ALTER TABLE CCCMATRETETE ADD CANTREALUNIT FLOAT;
ALTER TABLE CCCMATRETETE ADD NORMUNITMAN FLOAT;
ALTER TABLE CCCMATRETETE ADD TOTALOREMAN FLOAT;
ALTER TABLE CCCMATRETETE ADD PONNORMMAN FLOAT;
select d.denumire_art_of,
	c.denumire_art_of
from cccmatretete a
	inner join CCCACTIVITRETETE b on a.CCCACTIVITRETETE = b.CCCACTIVITRETETE
	inner join cccoferteweblinii c on (a.cccoferteweblinii = c.cccoferteweblinii)
	inner join cccoferteweblinii d on (b.cccoferteweblinii = d.cccoferteweblinii);
CREATE TABLE CCCTIPARTICOL (
	CCCTIPARTICOL INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	NAME VARCHAR(100) NOT NULL
);
CREATE TABLE CCCSUBTIPARTICOL (
	CCCSUBTIPARTICOL INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	NAME VARCHAR(100) NOT NULL
);
--'ARTICOL', 'SUBARTICOL', 'MATERIAL'
INSERT INTO CCCTIPARTICOL (NAME)
VALUES ('ARTICOL'),
	('SUBARTICOL'),
	('MATERIAL');
/*
 PRINCIPAL',
 'MATERIAL',
 'MANOPERA',
 'TRANSPORT',
 'ECHIPAMENT',
 'UTILAJ',
 'CUSTOM'*/
INSERT INTO CCCSUBTIPARTICOL (NAME)
VALUES ('PRINCIPAL'),
	('MATERIAL'),
	('MANOPERA'),
	('TRANSPORT'),
	('ECHIPAMENT'),
	('UTILAJ'),
	('CUSTOM');
create TABLE CCCINSTANTE (
	CCCOFERTEWEB INT NOT NULL,
	CCCINSTANTE INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	ISDUPLICATE SMALLINT NOT NULL DEFAULT 0,
	DUPLICATEOF INT,
	NAME VARCHAR(250) NOT NULL
);
CREATE TABLE CCCACTIVITINSTANTE (
	CCCOFERTEWEB INT NOT NULL,
	CCCINSTANTE INT NOT NULL,
	CCCACTIVITINSTANTE INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCOFERTEWEBLINII INT NOT NULL
);
CREATE TABLE CCCMATINSTANTE (
	CCCOFERTEWEB INT NOT NULL,
	CCCINSTANTE INT NOT NULL,
	CCCMATINSTANTE INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCACTIVITINSTANTE INT NOT NULL,
	CCCOFERTEWEBLINII INT NOT NULL
);
select d.denumire_art_of,
	d.CANT_ART_OF,
	c.denumire_art_of,
	c.CANT_ART_OF
from cccmatinstante a
	inner join CCCACTIVITINSTANTE b on a.CCCACTIVITINSTANTE = b.CCCACTIVITINSTANTE
	inner join cccoferteweblinii c on (a.cccoferteweblinii = c.cccoferteweblinii)
	inner join cccoferteweblinii d on (b.cccoferteweblinii = d.cccoferteweblinii);
alter table CCCMATINSTANTE ADD ISARTOF SMALLINT NOT NULL DEFAULT 0;
create table CCCANTEMASURATORI (
	CCCOFERTEWEB INT NOT NULL,
	CCCANTEMASURATORI INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCPATHS INT NOT NULL,
	CCCINSTANTE INT NOT NULL,
	CCCACTIVITINSTANTE INT NOT NULL,
	CCCOFERTEWEBLINII INT NOT NULL,
	CANTITATE FLOAT NOT NULL,
	ISARTOF SMALLINT NOT NULL DEFAULT 0
);
CREATE TABLE CCCESTIMARI (
	CCCESTIMARI INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCOFERTEWEB INT NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	DATASTART DATETIME NOT NULL,
	DATASTOP DATETIME NOT NULL
);
create table CCCACTIVITESTIMARI (
	CCCACTIVITESTIMARI INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCESTIMARI INT NOT NULL,
	CCCOFERTEWEB INT NOT NULL,
	CCCANTEMASURATORI INT NOT NULL,
	CANTITATE FLOAT NOT NULL,
	DATASTART DATETIME NOT NULL,
	DATASTOP DATETIME NOT NULL,
);
create table CCCMATESTIMARI (
	CCCMATESTIMARI INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCACTIVITESTIMARI INT NOT NULL,
	CCCESTIMARI INT NOT NULL,
	CCCOFERTEWEB INT NOT NULL,
	CCCANTEMASURATORI INT NOT NULL,
	CANTITATE FLOAT NOT NULL,
	DATASTART DATETIME NOT NULL,
	DATASTOP DATETIME NOT NULL,
);
create table CCCPLANIFICARI (
	CCCPLANIFICARI INT NOT NULL PRIMARY KEY IDENTITY(1, 1),
	CCCOFERTEWEB INT NOT NULL,
	NAME VARCHAR(100) NOT NULL,
	DATASTART DATETIME NOT NULL,
	DATASTOP DATETIME NOT NULL,
	RESPPLAN INT NOT NULL,
	RESPEXEC INT NOT NULL,
	INSDATE DATETIME NOT NULL DEFAULT GETDATE(),
	UPDDATE DATETIME NOT NULL DEFAULT GETDATE(),
	INSUSR INT NOT NULL DEFAULT 0,
	UPDUSR INT NOT NULL DEFAULT 0,
	STATUS INT NOT NULL DEFAULT 0
);
select i.*,
	*
from CCCANTEMASURATORI a
	inner join cccpaths b on (a.cccpaths = b.cccpaths)
	inner join cccoferteweblinii c on (c.cccoferteweblinii = a.cccoferteweblinii)
	inner join CCCINSTANTE d on (d.CCCINSTANTE = a.CCCINSTANTE)
	inner join cccretete h on (h.id = d.DUPLICATEOF)
	INNER JOIN CCCACTIVITINSTANTE G ON (
		G.CCCINSTANTE = D.CCCINSTANTE
		AND G.CCCACTIVITINSTANTE = A.CCCACTIVITINSTANTE
	)
	left join CCCACTIVITRETETE i on (
		i.CCCRETETE = h.cccretete
		AND i.cccoferteweblinii = a.cccoferteweblinii
	)
order by A.CCCINSTANTE,
	d.DUPLICATEOF,
	A.CCCACTIVITINSTANTE,
	b.path;
select a.CCCINSTANTE,
	d.DUPLICATEOF,
	c.id,
	a.CCCACTIVITINSTANTE,
	b.CCCACTIVITRETETE,
	e.CCCANTEMASURATORI,
	e.cccpaths,
	e.cantitate,
	b.ismain,
	b.iscustom,
	g.*,
	h.*
from CCCACTIVITINSTANTE a
	inner join CCCINSTANTE d on (
		d.CCCINSTANTE = a.CCCINSTANTE
		and d.cccoferteweb = a.cccoferteweb
	)
	left join CCCACTIVITRETETE b on (
		a.cccoferteweblinii = b.cccoferteweblinii
		and a.cccoferteweb = b.cccoferteweb
	)
	left join cccretete c on (
		c.cccretete = b.cccretete
		and c.cccoferteweb = b.cccoferteweb
	)
	inner join CCCANTEMASURATORI e on (
		e.CCCACTIVITINSTANTE = a.CCCACTIVITINSTANTE
		and e.cccoferteweb = a.cccoferteweb
	)
	inner join cccpaths f on (
		f.cccpaths = e.cccpaths
		and f.cccoferteweb = e.cccoferteweb
	)
	left join cccoferteweblinii g on (
		g.cccoferteweblinii = a.cccoferteweblinii
		and g.cccoferteweb = a.cccoferteweb
	) --daca am activitati custom in retete introdu-le in CCCACTIVITINSTANTE
	left join cccoferteweblinii h on (
		h.cccoferteweblinii = b.cccoferteweblinii
		and g.cccoferteweb = a.cccoferteweb
	)
where a.cccoferteweb = 1
order by d.DUPLICATEOF,
	a.CCCINSTANTE,
	a.CCCACTIVITINSTANTE,
	f.path;
select j.*,
	*
from CCCANTEMASURATORI a
	inner join cccpaths b on (a.cccpaths = b.cccpaths)
	inner join cccoferteweblinii c on (c.cccoferteweblinii = a.cccoferteweblinii)
	inner join CCCINSTANTE d on (d.CCCINSTANTE = a.CCCINSTANTE)
	inner join cccretete h on (h.id = d.DUPLICATEOF)
	INNER JOIN CCCACTIVITINSTANTE G ON (
		G.CCCINSTANTE = D.CCCINSTANTE
		AND G.CCCACTIVITINSTANTE = A.CCCACTIVITINSTANTE
	)
	left join CCCACTIVITRETETE i on (
		i.CCCRETETE = h.cccretete
		AND i.cccoferteweblinii = a.cccoferteweblinii
	)
	left join CCCACTIVITESTIMARI j ON (j.CCCANTEMASURATORI = a.CCCANTEMASURATORI)
	inner join CCCESTIMARI k ON (k.CCCESTIMARI = j.CCCESTIMARI)
WHERE i.CCCOFERTEWEB = 1
	and k.CCCESTIMARI = 1
order by A.CCCINSTANTE,
	d.DUPLICATEOF,
	A.CCCACTIVITINSTANTE,
	b.path;